<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" href="data:;base64,=">
    <title>Wind en Golven</title>
    <script>
        var uid_count = 0;

        function uid(name) {
            return new Id("O-" + (name == null ? "" : name + "-") + ++uid_count);
        }

        function Id(id) {
            this.id = id;
            this.href = new URL(`#${id}`, location) + "";
        }

        Id.prototype.toString = function() {
            return "url(" + this.href + ")";
        };
    </script>
    <script src="https://d3js.org/d3.v6.js"></script>
</head>
<body>
    <div id="wind-golven"></div>
<script type="module">
const margin = {top: 10, right: 30, bottom: 30, left: 60},
    width = 920 - margin.left - margin.right,
    height = 400 - margin.top - margin.bottom;

const min_date = "2011-01-01";
const max_date = "2011-12-31";

const windsnelheden = await d3.csv(`/api/windsnelheid?min_date=${min_date}&max_date=${max_date}`, d3.autoType);
const golfhoogtes = await d3.csv(`/api/golfhoogte?min_date=${min_date}&max_date=${max_date}`, d3.autoType);

/*const datum_extent = [new Date('2011-01-01'), new Date('2021-05-31')],
    wind_extent = [0.0, 33.0],
    golf_extent = [0.0, 530.0];
*/

const datum_extent = d3.extent(windsnelheden, d => d.datum),
    wind_extent = d3.extent(windsnelheden, d => d.value),
    golf_extent = d3.extent(golfhoogtes, d => d.value);

const x_scale = d3.scaleTime()
    .domain(datum_extent)
    .range([ 0, width ]);

const y_wind_scale = d3.scaleLinear()
    .domain([0, wind_extent[1]])
    .range([ height, 0 ]);

const y_golf_scale = d3.scaleLinear()
    .domain([0, golf_extent[1]])
    .range([ height, 0 ]);

const x_axis = (g, x) => g
    .attr("transform", `translate(0, ${height + margin.top})`)
    .call(d3
        .axisBottom(x)
        .ticks(width / 80)
        .tickSizeOuter(0)
    );

const y_axis_golf = (g, y) => g
    .attr("transform", `translate(${margin.left}, 0)`)
    .call(d3.axisLeft(y).ticks(null, "s"))
    .call(g => g.select(".domain").remove())
    .call(g => g.select(".tick:last-of-type text").clone()
        .attr("x", 3)
        .attr("text-anchor", "start")
        .attr("font-weight", "bold")
    );

const y_axis_wind = (g, y) => g
    .attr("transform", `translate(${width - margin.right}, 0)`)
    .call(d3.axisRight(y).ticks(null, "s"))
    .call(g => g.select(".domain").remove())
    .call(g => g.select(".tick:last-of-type text").clone()
        .attr("x", 3)
        .attr("text-anchor", "start")
        .attr("font-weight", "bold")
    );

const line = (data, x, y) => d3.line()
    .x(d => x(d.datum))
    .y(d => y(d.value))
    (data);

const zoom = d3.zoom()
    .scaleExtent([1, 32])
    .extent([[margin.left, 0], [width - margin.right, height]])
    .translateExtent([[margin.left, -Infinity], [width - margin.right, Infinity]])
    .on("zoom", zoomed);

const svg = d3.select('#wind-golven')
    .append('svg')
    .attr("viewBox", [0, 0, width, height + margin.top + margin.bottom]);

const clip = uid("clip");

svg.append("clipPath")
    .attr("id", clip.id)
    .append("rect")
    .attr("x", margin.left)
    .attr("y", margin.top)
    .attr("width", width - margin.left - margin.right)
    .attr("height", height);

const wind_path = svg.append("path")
    .attr("clip-path", clip)
    .attr("fill", "none")
    .attr("stroke", "steelblue")
    .attr("d", line(windsnelheden, x_scale, y_wind_scale));

const golf_path = svg.append("path")
    .attr("clip-path", clip)
    .attr("fill", "none")
    .attr("stroke", "aqua")
    .attr("d", line(golfhoogtes, x_scale, y_golf_scale));

const gx = svg.append("g")
    .call(x_axis, x_scale);

svg.append("g")
    .call(y_axis_wind, y_wind_scale);

svg.append("g")
    .call(y_axis_golf, y_golf_scale);

svg.call(zoom)
    .transition()
    .duration(750)
    .call(zoom.scaleTo, 4, [x_scale(Date.UTC(2012, 1, 15)), 0]);

function zoomed(event) {
    const xz = event.transform.rescaleX(x_scale);
    wind_path.attr("d", line(windsnelheden, xz, y_wind_scale));
    golf_path.attr("d", line(golfhoogtes, xz, y_golf_scale));
    gx.call(x_axis, xz);
}
</script>
</body>
</html>