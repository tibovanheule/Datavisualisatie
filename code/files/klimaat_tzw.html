<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" href="data:;base64,=">
    <title>Klimaattrend tzw</title>
    <script src="./js/d3.v6.js"></script>
    <style>

        button {
            background-color: rgba(51, 51, 51, 0.05);
            border-radius: 8px;
            border-width: 0;
            color: #333333;
            cursor: pointer;
            display: inline-block;
            font-family: "Haas Grot Text R Web", "Helvetica Neue", Helvetica, Arial, sans-serif;
            font-size: 14px;
            font-weight: 500;
            line-height: 20px;
            list-style: none;
            margin: 0;
            padding: 10px 12px;
            text-align: center;
            transition: all 200ms;
            vertical-align: baseline;
            white-space: nowrap;
            user-select: none;
            -webkit-user-select: none;
            touch-action: manipulation;
        }
    </style>
    <link rel="apple-touch-icon" sizes="180x180" href="./images/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="./images/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="./images/favicon-16x16.png">
    <link rel="manifest" href="./images/site.webmanifest">
    <link rel="shortcut icon" href="./images/favicon.ico">
    <meta name="msapplication-TileColor" content="#ffffff">
    <meta name="msapplication-config" content="./images/browserconfig.xml">
    <meta name="theme-color" content="#ffffff">
    <script src="https://cdn.jsdelivr.net/npm/d3-color@3"></script>
    <script src="https://cdn.jsdelivr.net/npm/d3-interpolate@3"></script>
    <script src="https://cdn.jsdelivr.net/npm/d3-scale-chromatic@3"></script>
</head>
<body>
<button onclick="show_all()">Toon alles</button>
<button onclick="hide_all()">Verberg alles</button>
<button onclick="animate_graph()">Animeer</button>
<div id="tzw_klimaat" style="display: block"></div>
</body>
<footer>
    <script>
        // set the dimensions and margins of the graph
        const margin = {top: 60, right: 20, bottom: 20, left: 30},
            width = 920 - margin.left - margin.right,
            height = 400 - margin.top - margin.bottom;

        // append the svg object to the body of the page
        const svg = d3.select("#tzw_klimaat")
            .append("svg")
            .attr("viewBox", [0, 0, width, height + margin.top + margin.bottom]);
        let groups = undefined;

        //Read the data
        d3.csv("./data/klimaat_tzw.csv").then((data) => {

            // List of groups (here I have one group per column)
            groups = [...new Set(data.map(d => d.year))].filter((value, index, array) => array.indexOf(value) === index);
            // Reformat the data: we need an array of arrays of {x, y} tuples
            let dataReady = groups.map((grpName) => { // .map allows to do something for each element of the list
                return {
                    name: grpName,
                    values: data.filter(d => d.year === grpName).map((d) => {
                        return {time: d.month, value: d.value};
                    })
                };
            });

            // A color scale: one color for each group
            const myColor = d3.scaleSequential(d3.interpolateBlues)
                .domain(d3.extent(groups))

            // Add X axis --> it is a date format
            const x = d3.scaleBand()
                .domain(data.map(d => d.month).sort((a, b) => {
                    return a - b;
                }))
                .range([margin.left, width - margin.left]);
            svg.append("g")
                .attr("transform", `translate(0, ${height + margin.top})`)
                .call(d3.axisBottom(x));

            // Add Y axis
            const y = d3.scaleLinear()
                .domain([0, 22])
                .range([height + margin.top, margin.top]);
            svg.append("g")
                .attr("transform", `translate(${margin.left}, 0)`)
                .call(d3.axisLeft(y).ticks(null, "s"))
                .call(g => g.select(".domain").remove())
                .call(g => g.select(".tick:last-of-type text").clone()
                    .attr("x", 3)
                    .attr("text-anchor", "start")
                    .attr("font-weight", "bold")
                );

            // Add the lines
            const line = d3.line()
                .x(d => x(d.time) + margin.left)
                .y(d => y(d.value))
            svg.selectAll("myLines")
                .data(dataReady)
                .join("path")
                .attr("class", d => 'c' + d.name.toString())
                .attr("d", d => line(d.values))
                .attr("stroke", d => myColor(d.name))
                .style("stroke-width", 2)
                .style("fill", "none")

            // Add the points
            svg
                // First we need to enter in a group
                .selectAll("myDots")
                .data(dataReady)
                .join('g')
                .style("fill", d => myColor(d.name))
                .attr("class", d => 'c' + d.name.toString())
                // Second we need to enter in the 'values' part of this group
                .selectAll("myPoints")
                .data(d => d.values)
                .join("circle")
                .attr("cx", d => x(d.time) + margin.left)
                .attr("cy", d => y(d.value))
                .attr("r", 3)
                .attr("stroke", "white")

            // Add a legend (interactive)
            svg
                .selectAll("myLegend")
                .data(dataReady)
                .join('g')
                .append("text")
                .attr('x', (_, i) => margin.left + 5 + (i % 15) * 40)
                .attr('y', (_, i) => {
                    return 30 + Math.floor(i / 15) * 30
                })
                .attr('class', d => "label" + d.name)
                .text(d => d.name)
                .style("fill", d => myColor(d.name))
                .style("font-size", 10)
                .on("click", function (event, d) {
                    // is the element currently visible ?
                    let currentOpacity = d3.selectAll(".c" + d.name).style("opacity")
                    // Change the opacity: from 0 to 1 or from 1 to 0
                    d3.selectAll(".c" + d.name).transition().style("opacity", currentOpacity == 1 ? 0 : 1)
                    //d3.selectAll(".c" + d.name).transition().style()
                })
        })

        function show_all() {
            if (groups) {
                for (let i of groups) {
                    d3.selectAll(".c" + i).transition().style("opacity", 1)
                }
            }
        }

        function hide_all() {
            if (groups) {
                for (let i of groups) {
                    d3.selectAll(".c" + i).transition().style("opacity", 0)
                }
            }
        }

        function animate_graph() {
            if (groups) {
                hide_all()
                for (let index in groups) {
                    let i = groups[index]
                    setTimeout((index) => {
                        d3.selectAll(".c" + i).transition().style("opacity", 1);
                        if ((index % 10) !== 0) {
                            setTimeout(() => {
                                d3.selectAll(".c" + i).transition().style("opacity", 0)
                            }, 3000);
                        }
                    }, 1000 * (index));
                }
            }
        }
    </script>
</footer>
</html>