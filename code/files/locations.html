<!DOCTYPE html>
<head>
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta charset="utf-8">

    <!-- Load d3.js -->
    <script src="https://d3js.org/d3.v6.js"></script>

    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.3.4/dist/leaflet.css"
          integrity="sha512-puBpdR0798OZvTTbP4A8Ix/l+A4dHDD0DGqYW6RQ+9jxkRFclaxxQb/SJAWZfWAkuyeQUytO7+7N4QKrDh+drA=="
          crossorigin=""/>
    <script src="https://unpkg.com/leaflet@1.3.4/dist/leaflet.js"
            integrity="sha512-nMMmRyTVoLYqjP9hrbed9S+FzjZHW5gY1TWCHA5ckwXZBadntCNs8kEqAWdrb9O7rxbCaA4lKTIWjDXZxflOcA=="
            crossorigin=""></script>

    <style>
        #mapid {
            height: 100vh;
        }

        body {
            margin: 0;
        }
    </style>
    <link rel="apple-touch-icon" sizes="180x180" href="/files/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/files/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/files/favicon-16x16.png">
    <link rel="manifest" href="/files/site.webmanifest">
    <link rel="shortcut icon" href="/files/favicon.ico">
    <meta name="msapplication-TileColor" content="#ffffff">
    <meta name="msapplication-config" content="/files/browserconfig.xml">
    <meta name="theme-color" content="#ffffff">
</head>
<!-- Create an element where the map will take place -->
<div id="mapid"></div>


<script type="module">
    const buoyIcon = L.icon({
        iconUrl: 'buoy.png',
        iconSize: [20, 20],
        iconAnchor: [0, 0],
    });
    const data = await fetch("/api/locations").then((d) => d.json());
    // mapid is the id of the div where the map will appear
    const map = L
        .map('mapid')
        .setView([51.2727669, 2.9650749], 10);   // center position + zoom
    // Add a tile to the map = a background. Comes from OpenStreetmap
    L.tileLayer(
        'https://stamen-tiles.a.ssl.fastly.net/terrain/{z}/{x}/{y}.jpg', {}).addTo(map);

    L.tileLayer.wms('https://bathytest.agentschapmdk.be/geoserver/gnwms/wms/?', {
        layers: 'NamedPlace',
        styles: 'GN_Source',
        format: 'image/png',
        transparent: true,
        opacity: 0.5
    }).addTo(map);

    // Add a svg layer to the map
    L.svg().addTo(map);

    // Select the svg area and add circles:
    data.forEach(d => {
        L.marker([d.latitude, d.longitude], {
            icon: buoyIcon,
            keyboard: false,

        }).addTo(map);
    });

    d3.select("#mapid")
        .select("svg")
        .selectAll("mytext")
        .data(data)
        .join("text")
        .attr("dx", d => map.latLngToLayerPoint([d.latitude, d.longitude]).x)
        .attr("dy", d => map.latLngToLayerPoint([d.latitude, d.longitude]).y)
        .text(d => d.name);

    // Function that update circle position if something change
    function update() {
        d3.selectAll("circle")
            .attr("cx", d => map.latLngToLayerPoint([d.latitude, d.longitude]).x)
            .attr("cy", d => map.latLngToLayerPoint([d.latitude, d.longitude]).y)

        d3.selectAll("text")
            .attr("dx", d => map.latLngToLayerPoint([d.latitude, d.longitude]).x)
            .attr("dy", d => map.latLngToLayerPoint([d.latitude, d.longitude]).y)
    }

    // If the user change the map (zoom or drag), I update circle position:
    map.on("moveend", update);
</script>