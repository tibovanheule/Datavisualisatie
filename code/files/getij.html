<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Getij</title>
    <script>
        let uid_count = 0;

        function uid(name) {
            return new Id("O-" + (name == null ? "" : name + "-") + ++uid_count);
        }

        function Id(id) {
            this.id = id;
            this.href = new URL(`#${id}`, location) + "";
        }

        Id.prototype.toString = function () {
            return "url(" + this.href + ")";
        };

        /**
         * Binary search algorithm to find the closest value to the target
         * @param arr: the array to search
         * @param predicate: function to select the value of the array element to compare to the target
         * @param target: target value to compare to
         */
         function binarySearch(arr, predicate, target, lo = 0, hi = arr.length - 1) {
            if (target < predicate(arr[lo])) {
                return arr[0]
            }
            if (target > predicate(arr[hi])) {
                return arr[hi]
            }

            const mid = Math.floor((hi + lo) / 2);

            return hi - lo < 2
                ? (target - predicate(arr[lo])) < (predicate(arr[hi]) - target) ? arr[lo] : arr[hi]
                : target < predicate(arr[mid])
                    ? binarySearch(arr, predicate, target, lo, mid)
                    : target > predicate(arr[mid])
                        ? binarySearch(arr, predicate, target, mid, hi)
                        : arr[mid]
        }

        Date.prototype.addHours = function(h) {
            const d = new Date(this.getTime() + (h*60*60*1000));
            return this;
        }
    </script>
    </script>
    <script src="https://d3js.org/d3.v6.js"></script>
    <link rel="apple-touch-icon" sizes="180x180" href="/files/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/files/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/files/favicon-16x16.png">
    <link rel="manifest" href="/files/site.webmanifest">
    <link rel="shortcut icon" href="/files/favicon.ico">
    <meta name="msapplication-TileColor" content="#ffffff">
    <meta name="msapplication-config" content="/files/browserconfig.xml">
    <meta name="theme-color" content="#ffffff">
    <style>
        .dotted {
            stroke: #5c5c5c;
            stroke-dasharray: 1 1;
            fill: none;
        }

        svg text.value-text {
            font-size: 1rem;
            paint-order: stroke;
            stroke: #FFFFFF;
            stroke-width: 2px;
            stroke-linecap: butt;
            stroke-linejoin: miter;
        }
    </style>
</head>
<body>
<div id="getij"></div>
<script type="module">
    const margin = {top: 10, right: 30, bottom: 30, left: 60},
        width = 920 - margin.left - margin.right,
        height = 400 - margin.top - margin.bottom;

    const lunar_data_future = d3.csv('/data/luna.csv', d3.autoType);
    const getij_data = await d3.csv(`/data/min_max_getij_blk.csv`, d3.autoType);
    const high_tide = getij_data.filter(d => d.value > 250);
    const neap_tide = getij_data.filter(d => d.value < 250);
    const tides = neap_tide.map((e, i) => {
        return {
            'datum_low': e.datum,
            'value_low': e.value,
            'datum_high': high_tide[i]?.datum,
            'value_high': high_tide[i]?.value
        };
    })

    const datum_extent = d3.extent(getij_data, d => d.datum);
    const getij_extent = d3.extent(getij_data, d => d.value);

    const x_scale = d3.scaleTime()
        .domain(datum_extent)
        .range([margin.left, width + margin.left]);

    const y_scale = d3.scaleLinear()
        .domain(getij_extent)
        .range([height + margin.top, margin.top]);

    const x_axis = (g, x) => g
        .attr("transform", `translate(0, ${height + margin.top})`)
        .call(d3
            .axisBottom(x)
            .ticks(width / 80)
            .tickSizeOuter(0)
        );

    const y_axis = (g, y) => g
        .attr("transform", `translate(${margin.left}, 0)`)
        .call(d3.axisLeft(y).ticks(null, "s"))
        .call(g => g.select(".domain").remove())
        .call(g => g.select(".tick:last-of-type text").clone()
            .attr("x", 3)
            .attr("text-anchor", "start")
            .attr("font-weight", "bold")
        );

    const area = (data, x, y) => d3.area()
        .curve(d3.curveBasis)
        .x0(d => x(d.datum_low))
        .y0(d => y(d.value_low))
        .x1(d => x(d.datum_high))
        .y1(d => y(d.value_high))
        (data);

    const zoom = d3.zoom()
        .scaleExtent([1, 32])
        .extent([[margin.left, 0], [width - margin.right, height]])
        .translateExtent([[margin.left, -Infinity], [width - margin.right, Infinity]])
        .on("zoom", zoomed);

    const svg = d3.select('#getij')
        .append('svg')
        .attr("viewBox", [0, 0, width, height + margin.top + margin.bottom])
        .on("mouseenter", onMouseEnter)
        .on("mousemove", onMouseMove)
        .on("mouseleave", onMouseLeave);

    const clip = uid("clip");

    svg.append("clipPath")
        .attr("id", clip.id)
        .append("rect")
        .attr("x", margin.left)
        .attr("y", margin.top)
        .attr("width", width)
        .attr("height", height);

    const getij_path = svg.append("path")
        .attr("clip-path", clip)
        .attr("fill", 'lightblue')
        .attr("stroke", "black")
        .attr("d", area(tides, x_scale, y_scale));

    const gx = svg.append("g")
        .call(x_axis, x_scale);

    svg.append("text")
        .attr("class", "x label")
        .attr("text-anchor", "end")
        .attr("x", width / 2)
        .attr("y", height + margin.bottom + margin.top)
        .attr("text-anchor", "middle")
        .attr("style", "font-size: 0.8em")
        .text("Datum");

    svg.append("g")
        .call(y_axis, y_scale);

    svg.append("text")
        .attr("class", "y label")
        .attr("text-anchor", "end")
        .attr("x", -height / 2)
        .attr("y", margin.left / 2 - 12)
        .attr("dy", ".75em")
        .attr("transform", "rotate(-90)")
        .attr("text-anchor", "middle")
        .attr("style", `font-size: 0.8em`)
        .text("Hoogtes hoogtij en laagtij (m TAW)");

    svg.call(zoom)
        .transition()
        .duration(250)
        .call(zoom.scaleTo, 16, [x_scale(Date.UTC(2015, 7, 1)), 0]);

    const moon_emoji = {0: "ðŸŒ•", 10: "ðŸŒ—", 20: "ðŸŒ‘", 30: "ðŸŒ“"};
    const lunar_data = await lunar_data_future.then(d => d.filter(d => d.date >= datum_extent[0] && d.date <= datum_extent[1]));
    const luna_group = svg.append("g").attr("clip-path", clip);
    const lunas = (d, x) => {
        luna_group.selectAll("text").remove();
        luna_group.selectAll("text")
            .data(lunar_data)
            .enter().append("text")
            .attr("x", d => x(d.date))
            .attr("y", height / 2 + margin.top)
            .attr("text-anchor", "middle")
            .text(d => moon_emoji[d.luna]);
    }
    lunas(lunar_data, x_scale);


    let xz = x_scale;
    function zoomed(event) {
        xz = event.transform.rescaleX(x_scale);
        getij_path.attr("d", area(tides, xz, y_scale));
        gx.call(x_axis, xz);
        lunas(lunar_data, xz)
    }

    const hover_elements = svg.append("g");
    function onMouseEnter(e) {
        const pointer = d3.pointer(e);
        const hoveredDate = xz.invert(pointer[0]);
        hover_elements.append("rect")
            .attr("id", "x-axis-line")
            .attr("class", "dotted")
            .attr("stroke-width", "1px")
            .attr("width", ".5px")
            .attr("height", height)
            .attr("x", pointer[0])
            .attr("y", margin.top);
        hover_elements.append("text")
            .attr("id", "datum-text")
            .attr("class", "value-text")
            .attr("x", pointer[0])
            .attr("y", height + margin.top - 3)
            .attr("text-anchor", "middle")
            .text(hoveredDate.toLocaleString());
        const {datum_low, value_low, datum_high, value_high} = binarySearch(tides, d => d.datum_low, hoveredDate);
        hover_elements.append("circle")
            .attr("id", "neap-tide")
            .attr("class", "value")
            .attr("r", "3px")
            .attr("cx", xz(datum_low))
            .attr("cy", y_scale(value_low));
        hover_elements.append("text")
            .attr("id", "neap-text")
            .attr("class", "value-text")
            .attr("x", xz(datum_low))
            .attr("y", y_scale(value_low))
            .text(value_low + "m");
        hover_elements.append("circle")
            .attr("id", "high-tide")
            .attr("class", "value")
            .attr("r", "3px")
            .attr("cx", xz(datum_high))
            .attr("cy", y_scale(value_high));
        hover_elements.append("text")
            .attr("id", "high-text")
            .attr("class", "value-text")
            .attr("x", xz(datum_low))
            .attr("y", y_scale(value_low))
            .text(value_high + "m");
    }

    function onMouseMove(e) {
        const pointer = d3.pointer(e);
        const hoveredDate = xz.invert(pointer[0]);
        hover_elements.select("#x-axis-line").attr("x", pointer[0]);
        hover_elements.select("#datum-text").attr("x", pointer[0]).text(hoveredDate.toLocaleString());
        const {datum_low, value_low, datum_high, value_high} = binarySearch(tides, d => d.datum_low.addHours(-3), hoveredDate);
        console.log({datum_low, value_low, datum_high, value_high});
        hover_elements.selectAll("#neap-tide")
            .attr("cx", xz(datum_low))
            .attr("cy", y_scale(value_low));
        hover_elements.selectAll("#high-tide")
            .attr("cx", xz(datum_high))
            .attr("cy", y_scale(value_high));
        hover_elements.selectAll("#neap-text")
            .attr("x", xz(datum_low)+3)
            .attr("y", y_scale(value_low)-3)
            .text(value_low + "m");
        hover_elements.selectAll("#high-text")
            .attr("x", xz(datum_high)+3)
            .attr("y", y_scale(value_high)-3)
            .text(value_high + "m");
    }

    function onMouseLeave(e) {
        hover_elements.selectChildren().remove();
    }
</script>
</body>
</html>